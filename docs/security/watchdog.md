# DNShield Watchdog

> Optional LaunchDaemon that monitors `/etc/hosts` for policy bypass attempts on managed macOS hosts.

## Overview

DNShield blocks domains at the DNS layer. A user with local administrator access can still edit `/etc/hosts` to short-circuit DNS resolution and regain access to a blocked destination. The watchdog daemon addresses that gap by:

1. Watching the system hosts file for changes.
2. Comparing overridden hostnames against the block rules maintained by DNShield.
3. Either logging the bypass attempt or removing the offending entries, based on policy.

The component is designed for enterprise deployments where host tampering is a concern and runs as a separate LaunchDaemon (`com.dnshield.watchdog`) so that security controls can be managed independently of the primary DNS proxy service.

## Architecture

| Element | Purpose |
| ------- | ------- |
| `watchdog` | Go binary that implements the monitoring loop. Built as a universal (arm64 + x86_64) executable. |
| LaunchDaemon plist (`com.dnshield.watchdog.plist`) | Optional service definition installed to `/Library/LaunchDaemons/`; disabled by default. |
| Rule database (`/var/db/dnshield/rules.db`) | SQLite database generated by the DNShield core. Supplies the authoritative list of blocked domains. |
| Preferences (`com.dnshield.watchdog`) | Stores watchdog-specific settings. |
| Log file (`/var/log/dnshield/watchdog.log`) | Consolidated stdout/stderr for daemon activity and alerts. |

The watchdog uses the macOS `kqueue` API to receive real-time notifications when `/etc/hosts` changes. If the kernel watcher cannot be initialised, it falls back to a low-frequency polling loop.

When a change is detected:

1. The daemon hashes the updated hosts file to avoid redundant processing.
2. The blocked-domain set is reloaded from the DNShield rule database.
3. Each host entry is inspected:
   - If `RemoveBlockBypassEntries` is `false`, the daemon logs the bypass attempt but leaves the file untouched.
   - If `true`, offending domains are stripped (or the entire line replaced with an audit comment if nothing else remains).
4. The rewritten hosts file is atomically persisted with the original permissions preserved.

By modelling the block list after DNShield's own precedence rules, the watchdog can identify bypass attempts on exact matches, wildcards (e.g. `*.example.com`) and regular expressions.

## Deployment

The watchdog is part of the enterprise build artifacts. The packaging script (`build_enterprise.sh`) will:

1. Attempt to build `watchdog` with Go 1.25 or newer (the binary is skipped if a compatible toolchain is not present).
2. Copy the compiled binary into `DNShield.app/Contents/MacOS` and optionally create a symlink in `/usr/local/bin` during installation.
3. Install the LaunchDaemon plist to `/Library/LaunchDaemons/com.dnshield.watchdog.plist`, owned by `root:wheel`.
4. Ensure `/var/log/dnshield` exists so the daemon can write its log file.

### Enabling the service

After installing DNShield (enterprise package), enable the watchdog on systems that require host tamper protection:

```bash
sudo launchctl enable system/com.dnshield.watchdog
sudo launchctl start com.dnshield.watchdog
```

To disable it again:

```bash
sudo launchctl disable system/com.dnshield.watchdog
sudo launchctl stop com.dnshield.watchdog
```

You can also run the binary interactively for debugging:

```bash
sudo /Applications/DNShield.app/Contents/MacOS/watchdog
```

## Configuration

Watchdog behaviour is controlled by the `com.dnshield.watchdog` preference domain.

| Key | Type | Default | Description |
| --- | ---- | ------- | ----------- |
| `RemoveBlockBypassEntries` | Boolean | `false` | When `false`, the daemon only logs detected overrides. When `true`, offending hosts entries are removed and replaced with an audit comment containing a timestamp and the domains that were stripped. |

## Logging and Alerting

All activity is written to `/var/log/dnshield/watchdog.log`. Typical entries include:

- Startup message noting that monitoring has begun.
- Errors loading `/etc/hosts` or the rule database.
- A human-readable summary whenever blocked domains are detected or removed.

This file can be ingested by central logging solutions or monitored with standard tools:

```bash
sudo tail -f /var/log/dnshield/watchdog.log
```

## Operational Considerations

- **Rule database availability:** The watchdog relies on the DNS rule database. If `/var/db/dnshield/rules.db` is missing, the daemon logs a warning and continues without enforcement. Ensure the primary DNShield components have seeded the database before enabling the watchdog.
- **File monitoring strategy:** The daemon uses the macOS kqueue API for real-time monitoring of `/etc/hosts`. If kqueue cannot be initialized, it falls back to polling the hosts file every three seconds. You can adjust the constant `pollInterval` in `main.go` if you need shorter or longer intervals for the fallback.
- **Hosts file permissions:** Rewrites preserve the existing file mode by writing to a temporary file in the same directory and performing an atomic rename.
- **Interoperability:** The daemon removes only the domains that match blocked rules, leaving other entries (e.g. loopback aliases) intact. Inline comments are preserved.
- **Performance:** The blocked-domain set is rebuilt on each detected change. On systems with large custom rule sets, consider allocating more CPU if hosts tampering is frequent.
